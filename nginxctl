#!/bin/bash

NGINX_BIN="/usr/local/nginx/sbin/nginx"
NGINX_PID="/usr/local/nginx/logs/nginx.pid"
NGINX_LOG="/usr/local/nginx/logs/error.log"
PID_FILE="/usr/local/nginx/logs/nginx.pid"

LARAVEL_LOG="/path/to/laravel/storage/logs/laravel.log"
PHPFPM_SERVICE="php8.2-fpm"
PHPFPM_ERROR_LOG="/var/log/php8.2-fpm.log"  # cek di system kamu, bisa beda

function is_nginx_running() {
    pgrep -x nginx > /dev/null
    return $?
}

function check_ports() {
    echo "🔍 Mengecek port 8000 dan 8443..."
    sudo lsof -i :8000 -sTCP:LISTEN
    sudo lsof -i :8443 -sTCP:LISTEN
}

function check_laravel_log() {
    echo "=== Last 20 lines of Laravel error log ==="
    tail -n 20 "$LARAVEL_LOG"
}

function check_phpfpm_log() {
    echo "=== Last 20 lines of PHP-FPM error log ==="
    tail -n 20 "$PHPFPM_ERROR_LOG"
}

function php_fpm_start() {
    sudo systemctl start $PHPFPM_SERVICE
    echo "PHP-FPM started."
}

function php_fpm_stop() {
    sudo systemctl stop $PHPFPM_SERVICE
    echo "PHP-FPM stopped."
}

function php_fpm_restart() {
    sudo systemctl restart $PHPFPM_SERVICE
    echo "PHP-FPM restarted."
}

function php_fpm_status() {
    sudo systemctl status $PHPFPM_SERVICE --no-pager
}


case "$1" in
  start)
    if is_nginx_running; then
      echo "⚠️  Nginx sudah berjalan."
    else
      echo "🚀 Memulai Nginx..."
      check_ports
      sudo $NGINX_BIN
      sleep 1
      if is_nginx_running; then
        echo "✅ Nginx berhasil dimulai."
      else
        echo "❌ Gagal memulai Nginx. Lihat log: $NGINX_LOG"
      fi
    fi
    ;;
  stop)
    echo "🛑 Menghentikan Nginx..."

    if [ -f "$PID_FILE" ]; then
      PID=$(cat "$PID_FILE")
      if kill "$PID" 2>/dev/null; then
        echo "✅ Nginx berhasil dihentikan."
      else
        echo "⚠️  Gagal kill proses PID $PID. Coba pakai sudo atau periksa izin akses."
    fi
    else
       echo "❌ PID file tidak ditemukan di $PID_FILE"
       echo "ℹ️  Coba cek manual dengan: ps aux | grep nginx"
    fi
    ;;
  restart)
    $0 stop
    sleep 1
    $0 start
    ;;
  log)
    echo "📄 Menampilkan log error Nginx:"
    tail -f $NGINX_LOG
    ;;
  ports)
    check_ports
    ;;
  laravel-log)
        check_laravel_log
        ;;
  phpfpm-log)
        check_phpfpm_log
        ;;
  fpmstart)
        php_fpm_start
        ;;
  fpmstop)
        php_fpm_stop
        ;;
  fpmrestart)
        php_fpm_restart
        ;;
  fpmstatus)
        php_fpm_status
        ;;
  *)
    echo "🔧 Gunakan: $0 {start|stop|restart|log|ports|laravel-log|phpfpm-log|fpmstart|fpmstop|fpmrestart|fpmstatus}"
    ;;

esac
