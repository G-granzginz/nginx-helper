#!/bin/bash

NGINX_USER="nginxadmin"
NGINX_GROUP="nginxadmin"

NGINX_BIN="/usr/local/nginx/sbin/nginx"
NGINX_PID="/usr/local/nginx/logs/nginx.pid"
NGINX_LOG="/usr/local/nginx/logs/error.log"
PID_FILE="/usr/local/nginx/logs/nginx.pid"

LARAVEL_LOG="/var/www/devfrontnogosec/storage/logs/laravel.log"
PHPFPM_SERVICE="php8.2-fpm"
PHPFPM_ERROR_LOG="/var/log/php8.2-fpm.log"  # cek di system kamu, bisa beda

function is_nginx_running() {
    pgrep -x nginx > /dev/null
    return $?
}

function check_ports() {
    echo "ðŸ” Mengecek port 8000 dan 8443..."
    sudo lsof -i :8000 -sTCP:LISTEN
    sudo lsof -i :8443 -sTCP:LISTEN
}

fix_permissions() {
  echo "ðŸ”§ Fixing storage & cache ownership to $NGINX_USER:$NGINX_GROUP ..."
  sudo chown -R "$NGINX_USER:$NGINX_GROUP" storage bootstrap/cache
}

function laravel_cache() {
    echo "Running Laravel cache commands..."
    cd /var/www/devfrontnogosec || { echo "Failed to cd to project folder"; exit 1; }
    php artisan config:cache
    php artisan route:cache
    php artisan view:cache
    echo "Rename modifier file because generated by itself as a root.."
    fix_permissions
}


function check_laravel_log() {
    echo "=== Last 150 lines of Laravel error log ==="
    tail -n 150 "$LARAVEL_LOG"
}

function check_phpfpm_log() {
    echo "=== Last 150 lines of PHP-FPM error log ==="
    tail -n 150 "$PHPFPM_ERROR_LOG"
}

function php_fpm_start() {
    sudo systemctl start $PHPFPM_SERVICE
    echo "PHP-FPM started."
}

function php_fpm_stop() {
    sudo systemctl stop $PHPFPM_SERVICE
    echo "PHP-FPM stopped."
}

function php_fpm_restart() {
    sudo systemctl restart $PHPFPM_SERVICE
    echo "PHP-FPM restarted."
}

function php_fpm_status() {
    sudo systemctl status $PHPFPM_SERVICE --no-pager
}


case "$1" in
  start)
    if is_nginx_running; then
      echo "âš ï¸  Nginx sudah berjalan."
    else
      echo "ðŸš€ Memulai Nginx..."
      check_ports
      sudo $NGINX_BIN
      sleep 1
      if is_nginx_running; then
        echo "âœ… Nginx berhasil dimulai."
      else
        echo "âŒ Gagal memulai Nginx. Lihat log: $NGINX_LOG"
      fi
    fi
    ;;
  stop)
    echo "ðŸ›‘ Menghentikan Nginx..."

    if [ -f "$PID_FILE" ]; then
      PID=$(cat "$PID_FILE")
      if kill "$PID" 2>/dev/null; then
        echo "âœ… Nginx berhasil dihentikan."
      else
        echo "âš ï¸  Gagal kill proses PID $PID. Coba pakai sudo atau periksa izin akses."
    fi
    else
       echo "âŒ PID file tidak ditemukan di $PID_FILE"
       echo "â„¹ï¸  Coba cek manual dengan: ps aux | grep nginx"
    fi
    ;;
  restart)
    $0 stop
    sleep 1
    $0 start
    ;;
  log)
    echo "ðŸ“„ Menampilkan log error Nginx:"
    tail -f $NGINX_LOG
    ;;
  ports)
    check_ports
    ;;
  laravel-log)
        check_laravel_log
        ;;
  phpfpm-log)
        check_phpfpm_log
        ;;
  phpfpmstart)
        php_fpm_start
	laravel_cache
        ;;
  phpfpmstop)
        php_fpm_stop
	laravel_cache
        ;;
  phpfpmrestart)
        php_fpm_restart
	laravel_cache
        ;;
  phpfpmstatus)
        php_fpm_status
        ;;
  restarteperithing)
	$0 stop
	sleep 1
	$0 start
	php_fpm_restart
	laravel_cache
	;;
  *)
    echo "ðŸ”§ Gunakan: $0 {restarteperithing|start|stop|restart|log|ports|laravel-log|phpfpm-log|phpfpmstart|phpfpmstop|phpfpmrestart|phpfpmstatus}"
    ;;

esac
